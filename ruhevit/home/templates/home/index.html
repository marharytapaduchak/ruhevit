{% extends "core/base.html" %}
{% load static %}

{% block title %}Мої запити{% endblock %}

{% block extra_css %}
<style>
  /* Стилі для фільтрів */
  .filters-and-sorting {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 25px;
    align-items: center;
  }
  
  .filter-button, .sorting-button {
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 10px 15px;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    transition: all 0.3s;
  }
  
  .filter-button:hover, .sorting-button:hover {
    background: #f5f5f5;
  }
  
  .filter-menu, .sort-options {
    position: absolute;
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    z-index: 100;
    margin-top: 5px;
    width: 280px;
  }
  
  .filter-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  
  .filter-group {
    margin-bottom: 15px;
  }
  
  .filter-group h4 {
    margin-bottom: 8px;
    font-size: 15px;
    color: #555;
  }
  
  .filter-group .options {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  
  .filter-option {
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 16px;
    padding: 6px 12px;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.3s;
  }
  
  .filter-option:hover {
    background: #e9ecef;
  }
  
  .filter-option.active {
    background: #F9A826;
    color: white;
    border-color: #F9A826;
  }
  
  .apply-filters {
    background: #F9A826;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 10px 15px;
    width: 100%;
    cursor: pointer;
    transition: background 0.3s;
    margin-top: 10px;
    font-weight: 500;
  }
  
  .apply-filters:hover {
    background: #E89619;
  }
</style>
{% endblock %}

{% block content %}
<div class="feed-mil">
  <!-- Секція "Ваші запити як ініціатора" -->
  <section class="requests-block">
    <h2 class="requests-text">Ваші запити як ініціатора</h2>
    <div class="requests">
      {% if user_owner_requests %}
        {% for req in user_owner_requests %}
          <article class="request" data-type="{{ req.help_type }}" data-location="{{ req.location }}" data-priority="{{ req.priority }}">
            <!-- Ваш існуючий код для запитів -->
          </article>
        {% endfor %}
      {% else %}
        <p>Поки що ви не створили жодного запиту.</p>
      {% endif %}
    </div>
  </section>

  <!-- Секція "Ваші запити як виконавця" -->
  <section class="requests-block">
    <h2 class="requests-text">Ваші запити як виконавця</h2>
    <div class="requests">
      {% for req in user_exec_requests %}
        <article class="request" data-type="{{ req.help_type }}" data-location="{{ req.location }}" data-priority="{{ req.priority }}">
          <!-- Ваш існуючий код для запитів -->
        </article>
      {% empty %}
        <p>Поки що ви не прийняли жодного запиту.</p>
      {% endfor %}
    </div>
  </section>

  <!-- Секція "Пропозиції допомоги" з покращеними фільтрами -->
  <section class="help-offers">
    <h2 class="section-title">Пропозиції</h2>
    
    <!-- Покращений блок фільтрів -->
    <div class="filters-and-sorting">
      <div class="filter-section">
        <button class="filter-button">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M6 10.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5z"/>
          </svg>
          <span class="filter-text">Фільтри</span>
        </button>
        
        <div id="filter-menu" class="filter-menu" style="display: none;">
          <div class="filter-group">
            <h4>Тип допомоги</h4>
            <div class="options">
              <div class="filter-option" data-filter="type" data-value="medicine">Медицина</div>
              <div class="filter-option" data-filter="type" data-value="ammo">Амуніція</div>
              <div class="filter-option" data-filter="type" data-value="drones">Дрони</div>
              <div class="filter-option" data-filter="type" data-value="transport">Транспорт</div>
              <div class="filter-option" data-filter="type" data-value="repair">Ремонт</div>
            </div>
          </div>
          
          <div class="filter-group">
            <h4>Локація</h4>
            <div class="options">
              <div class="filter-option" data-filter="location" data-value="front">Фронт</div>
              <div class="filter-option" data-filter="location" data-value="near_rear">Близький тил</div>
              <div class="filter-option" data-filter="location" data-value="far_rear">Далекий тил</div>
            </div>
          </div>
          
          <div class="filter-group">
            <h4>Пріоритет</h4>
            <div class="options">
              <div class="filter-option" data-filter="priority" data-value="high">Високий</div>
              <div class="filter-option" data-filter="priority" data-value="medium">Середній</div>
              <div class="filter-option" data-filter="priority" data-value="low">Низький</div>
            </div>
          </div>
          
          <button class="apply-filters">Застосувати фільтри</button>
        </div>
      </div>
      
      <div class="sort-section">
        <button class="sorting-button" id="sorting-button">
          <span class="sort-text">&#8645; Сортування</span>
        </button>
        <div id="sort-options" class="sort-options" style="display: none;">
          <label class="sort-option"><input type="radio" name="sort" value="default" checked> За релевантністю</label>
          <label class="sort-option"><input type="radio" name="sort" value="newest"> Від новіших</label>
          <label class="sort-option"><input type="radio" name="sort" value="oldest"> Від старіших</label>
          <label class="sort-option"><input type="radio" name="sort" value="alphabetical"> За алфавітом</label>
        </div>
      </div>
    </div>
    
    <div class="offers-container">
      {% if personalized_requests %}
        {% for offer in personalized_requests %}
          <article class="offer-card" data-created-at="{{ offer.created_at|date:'Y-m-d-H-i-s' }}" data-type="{{ offer.type }}" data-relevance="{{ offer.relevance_score }}" data-location="{{ offer.location }}" data-priority="{{ offer.priority }}">
            <!-- Ваш існуючий код для пропозицій -->
          </article>
        {% endfor %}
      {% else %}
        <p>Наразі немає пропозицій допомоги.</p>
      {% endif %}
    </div>
  </section>
</div>

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  // Функціонал фільтрів
  const filterButton = document.querySelector(".filter-button");
  const filterMenu = document.getElementById("filter-menu");
  const sortButton = document.getElementById("sorting-button");
  const sortOptions = document.getElementById("sort-options");
  const applyFiltersBtn = document.querySelector(".apply-filters");
  
  // Перемикання видимості меню фільтрів
  if (filterButton && filterMenu) {
    filterButton.addEventListener("click", (e) => {
      e.stopPropagation();
      filterMenu.style.display = filterMenu.style.display === "none" ? "block" : "none";
      if (sortOptions) sortOptions.style.display = "none";
    });
  }
  
  // Перемикання видимості опцій сортування
  if (sortButton && sortOptions) {
    sortButton.addEventListener("click", (e) => {
      e.stopPropagation();
      sortOptions.style.display = sortOptions.style.display === "none" ? "block" : "none";
      if (filterMenu) filterMenu.style.display = "none";
    });
  }
  
  // Закриття меню при кліку поза ним
  document.addEventListener("click", function() {
    if (filterMenu) filterMenu.style.display = "none";
    if (sortOptions) sortOptions.style.display = "none";
  });
  
  // Обробка вибору фільтрів
  const filterOptions = document.querySelectorAll(".filter-option");
  filterOptions.forEach(option => {
    option.addEventListener("click", function() {
      this.classList.toggle("active");
    });
  });
  
  // Застосування фільтрів
  if (applyFiltersBtn) {
    applyFiltersBtn.addEventListener("click", function() {
      const activeFilters = {
        types: [],
        locations: [],
        priorities: []
      };
      
      // Збираємо активні фільтри
      document.querySelectorAll(".filter-option.active").forEach(option => {
        const filterType = option.dataset.filter;
        const value = option.dataset.value;
        
        if (filterType === "type") activeFilters.types.push(value);
        else if (filterType === "location") activeFilters.locations.push(value);
        else if (filterType === "priority") activeFilters.priorities.push(value);
      });
      
      // Фільтрація карток
      const allCards = document.querySelectorAll(".offer-card, .request");
      let hasVisibleCards = false;
      
      allCards.forEach(card => {
        const cardType = card.dataset.type;
        const cardLocation = card.dataset.location;
        const cardPriority = card.dataset.priority;
        
        const typeMatch = activeFilters.types.length === 0 || activeFilters.types.includes(cardType);
        const locationMatch = activeFilters.locations.length === 0 || activeFilters.locations.includes(cardLocation);
        const priorityMatch = activeFilters.priorities.length === 0 || activeFilters.priorities.includes(cardPriority);
        
        if (typeMatch && locationMatch && priorityMatch) {
          card.style.display = "";
          hasVisibleCards = true;
        } else {
          card.style.display = "none";
        }
      });
      
      // Показуємо повідомлення, якщо немає відповідних карток
      const emptyMessage = document.querySelector(".no-results-message");
      if (!hasVisibleCards) {
        if (!emptyMessage) {
          const message = document.createElement("p");
          message.className = "no-results-message";
          message.textContent = "Немає результатів, що відповідають вибраним фільтрам.";
          document.querySelector(".offers-container, .requests").appendChild(message);
        }
      } else if (emptyMessage) {
        emptyMessage.remove();
      }
      
      // Закриваємо меню фільтрів
      if (filterMenu) filterMenu.style.display = "none";
    });
  }
  
  // Функціонал сортування
  const sortRadios = document.querySelectorAll('input[name="sort"]');
  sortRadios.forEach(radio => {
    radio.addEventListener("change", function() {
      const sortValue = this.value;
      const container = document.querySelector(".offers-container, .requests");
      const cards = Array.from(container.querySelectorAll(".offer-card, .request"));
      
      cards.sort((a, b) => {
        if (sortValue === "newest") {
          return new Date(b.dataset.createdAt) - new Date(a.dataset.createdAt);
        } else if (sortValue === "oldest") {
          return new Date(a.dataset.createdAt) - new Date(b.dataset.createdAt);
        } else if (sortValue === "alphabetical") {
          const titleA = a.querySelector(".offer-title, .request-title").textContent.trim();
          const titleB = b.querySelector(".offer-title, .request-title").textContent.trim();
          return titleA.localeCompare(titleB);
        } else { // default (relevance)
          const relevanceA = parseInt(a.dataset.relevance || 0);
          const relevanceB = parseInt(b.dataset.relevance || 0);
          return relevanceB - relevanceA;
        }
      });
      
      // Очищаємо контейнер і додаємо відсортовані картки
      container.innerHTML = "";
      cards.forEach(card => container.appendChild(card));
      
      // Закриваємо меню сортування
      if (sortOptions) sortOptions.style.display = "none";
    });
  });
});
</script>
{% endblock %}
{% endblock %}
